# ルーティングキーの作成

##目的

ルーティングキーは、モニタリングシステムからのアラートメッセージをエスカレーションポリシーにマッピングします。それにより、アラートがエスカレーションポリシーを通じて適切なチームに通知を送られるようになります。

ルーティングキーは大文字と小文字を区別せず、文字、数字、ハイフン、アンダースコアのみで構成されることに注意してください。

このモジュールでは、いくつかのルーティングキーを作成し、それらを前の演習で作成したエスカレーションポリシーにリンクさせていきます。

---

## 1. インスタンスID

各参加者には、それぞれ固有のルーティングキーが必要となります。このワークショップでは、ルーティングキーとして、各位に割り当てられたEC2インスタンスのホスト名を使用していきます。これは、ルーティングキーが一意である必要があり、ワークショップ開催においては運営上、一意であることが自明なホスト名が使いやすいというのが理由です。実際の本番環境では、ルーティングキーには、監視対象のシステムやサービスの名前、または1st Line Supportなどのチーム名を使うと良いでしょう。

ウェルカムメールには、本ワークショップで使用するEC2インスタンスの詳細が記載されており、第1回目の演習の一部としてログインしているはずです。

電子メールには、インスタンスのホスト名が記載されていますが、インスタンスから直接取得することもできます。インスタンスに接続されたシェル・セッションからホスト名を取得するには、次のコマンドを実行してください。

=== "Shell コマンド"

    ```text
    echo ${HOSTNAME}
    ```

=== "Example Output"

    ```text
    zevn
    ```

ルーティングキーを作成する際には、割り当てられた4文字のホスト名を使用することが非常に重要です。これは、Splunk Infrastructure Monitoringで定義しているDetectorが、この名前を使用して設定されているためであり、違う名前を使ってしまうとアラートが通知されなくなります。

## 2 ルーティングキーを作成する

メインメニューバーの **Settings** から、　**Routing Keys**　を開いてください。

{==HOSTNAME==}はホスト名に置き換え、{==TEAM_NAME==}は割り当てられた、または以前に作成したチームに置き換えてください。

| Routing Key | Escalation Policies |
| --- | --- |
| {==HOSTNAME==}_PRI | {==TEAM_NAME==} : Primary |
| {==HOSTNAME==}_WR | {==TEAM_NAME==} : Waiting Room |

すでにいくつかのルーティングキーが設定されているかもしれません。新しいルーティングキーを追加するには、ページの一番下までスクロールして、**Add Key** をクリックします。

左側のボックスに、上の表のようにキーの名前を入力します。**Routing Key** 列で、**Escalation Polices** 列のドロップダウンから、チームの **Primary** ポリシーを選択します。 結果をフィルタリングするために、チーム名を入力することができます。

![Add Routing Key](../../images/oncall/routing-key-add.png)

!!! 注意
    ワークショップの参加者数が多く、エスカレーションポリシーの数が異常に多い場合、検索フィルターでチーム名の下にあるすべてのポリシーが表示されないことがあります。 このような場合は、検索機能を使わずに、チーム名の下にスクロールすると、すべてのポリシーが表示されます。

上記の手順を、{==xxxx_PRI==} と {==xxxx_WR==} の2つのキーに対して行い、チームのプライマリとウェイティングルームのポリシーにマッピングします。

これで、以下のような2つのルーティングキーが設定されたはずです。

![Routing Keys](../../images/oncall/routing-keys.png)

!!! tips
    1つのルーティングキーを複数のエスカレーションポリシーに割り当てることもできます。

**Teams → [あなたのチーム名] → Escalation Policies** に戻って、**Primary** と **Waiting Room** ポリシーの設定を見ると、これらに **Routes** が割り当てられているか確認しましょう。

![Routing Keys Assigned](../../images/oncall/routing-keys-assigned.png)

**24/7** ポリシーにはルートが割り当てられていません。**Primary** ポリシーから **Execute Policy** エスカレーションを介してトリガされる前提で作られたポリシーのため、割り当てる必要がありません。

---

「インシデント ライフサイクル概要」モジュールに進む前に、講師の指示をお待ちください。
